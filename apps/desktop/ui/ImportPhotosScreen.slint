import { Button, CheckBox, ComboBox, ProgressIndicator, ScrollView, TextEdit } from "std-widgets.slint";

export struct ImportThumbnail {
    id: int,
    path: string,
    display_thumb: image,
    selected: bool,
    checked: bool,
    already_imported: bool,
    selectable: bool,
}

component ImportThumbnailCard inherits Rectangle {
    in property <string> path;
    in property <image> thumbnail;
    in property <bool> selected: false;
    in property <bool> checked: false;
    in property <bool> already-imported: false;
    in property <bool> selectable: true;
    in property <length> thumb-size: 200px;
    in property <length> card-width: 216px;
    in property <length> card-height: 272px;
    callback thumbnail_clicked(shift: bool, ctrl: bool);
    callback checkbox_clicked(checked: bool);

    width: card-width;
    height: card-height;
    preferred-width: card-width;
    preferred-height: card-height;
    border-radius: 8px;
    background: selected ? #182c52 : touch_area.has-hover ? #1c1c1c : #141414;
    border-width: selected ? 2px : 1px;
    border-color: selected ? #3a6dff : #3a3a3a;
    clip: true;

    animate background, border-color { duration: 120ms; }

    VerticalLayout {
        padding: 10px;
        spacing: 10px;
        width: parent.width;
        height: parent.height;

        // Selection area (thumbnail + label)
        touch_area := TouchArea {
            width: parent.width;
            height: root.thumb-size + 40px;
            enabled: root.selectable;
            pointer-event(event) => {
                if (event.kind == PointerEventKind.up) {
                    let ctrl = event.modifiers.control || event.modifiers.meta;
                    thumbnail_clicked(event.modifiers.shift, ctrl);
                }
            }

            VerticalLayout {
                spacing: 8px;
                Rectangle {
                    background: #0f0f0f;
                    border-radius: 6px;
                    height: root.thumb-size;
                    width: parent.width - 4px;
                    clip: true;
                    Image {
                        source: thumbnail;
                        width: parent.width;
                        height: parent.height;
                        image-fit: contain;
                        image-rendering: smooth;
                        opacity: root.selectable ? 1.0 : 0.45;
                    }

                    if root.already-imported: Rectangle {
                        background: #000000aa;
                        border-radius: 6px;
                        HorizontalLayout {
                            padding: 6px;
                            spacing: 6px;
                            Text {
                                text: "Already Imported";
                                color: #c6c6c6;
                                font-size: 11px;
                                font-weight: 600;
                            }
                        }
                    }
                }

                Text {
                    text: path;
                    font-size: 11px;
                    wrap: no-wrap;
                    overflow: elide;
                    color: root.selectable ? #d0d0d0 : #777;
                }
            }
        }

        HorizontalLayout {
            spacing: 6px;
            CheckBox {
                text: checked ? "Include" : "Skip";
                checked: root.checked;
                enabled: root.selectable && !root.already-imported;
                toggled => {
                    if (!root.selected) {
                        thumbnail_clicked(false, false);
                    }
                    checkbox_clicked(self.checked);
                }
            }
            if root.already-imported: Text {
                text: "Already imported";
                color: #9a9a9a;
                font-size: 11px;
            }
        }
    }

}

export component ImportPhotosScreen inherits Window {
    width: 1400px;
    height: 900px;
    title: "Import Photos";

    in-out property <[ImportThumbnail]> thumbnails;
    in-out property <[string]> directories;
    in-out property <[string]> selected_paths;
    in-out property <[string]> error_messages;
    in-out property <string> selected_directory;
    in-out property <string> destination_directory;
    in-out property <string> keywords;
    in-out property <bool> allow_duplicates: false;
    in-out property <bool> show_destination: false;
    in-out property <bool> importing: false;
    in-out property <float> progress: 0.0;
    in-out property <string> status_text;

    callback directory_selected(path: string);
    callback browse_for_directory();
    callback browse_for_destination();
    callback thumbnail_clicked(image_id: int, shift: bool, ctrl: bool);
    callback checkbox_clicked(checked: bool);
    callback select_all_requested(all_selected: bool);
    callback keyboard_select_all();
    callback keyboard_clear_selection();
    callback perform_import(
        source_directory: string,
        destination_directory: string,
        file_paths: [string],
        keywords: string,
        method: string
    );
    callback cancel_import;

    property <int> grid_columns: 4;
    property <length> thumb_size: 200px;
    property <length> thumb_gap: 12px;
    property <length> thumb_padding: 10px;
    property <length> card_width: root.thumb_size + 16px;
    property <length> card_height: root.thumb_size + 72px;
    in-out property <string> current_method: "Add";

    changed current_method => {
        show_destination = current_method != "Add";
    }

    forward-focus: shortcuts;

    shortcuts := FocusScope {
        width: parent.width;
        height: parent.height;

        key_pressed(event) => {
            if (keywords_field.has-focus) {
                return reject;
            }

            if ((event.modifiers.control || event.modifiers.meta) && (event.text == "a" || event.text == "A")) {
                root.keyboard_select_all();
                return accept;
            }

            if ((event.modifiers.control || event.modifiers.meta) && (event.text == "d" || event.text == "D")) {
                root.keyboard_clear_selection();
                return accept;
            }

            return reject;
        }

        Rectangle {
            background: #101010;
            width: parent.width;
            height: parent.height;

            VerticalLayout {
                padding: 12px;
                spacing: 12px;

                // Main panels
                HorizontalLayout {
                    spacing: 12px;
                    vertical-stretch: 1;

                // Left: directory browser
                Rectangle {
                    width: 260px;
                    background: #181818;
                    border-radius: 6px;
                    HorizontalLayout {
                        padding: 8px;
                        VerticalLayout {
                            spacing: 8px;
                            Text { text: "Folders"; font-weight: 600; }
                            Button {
                                text: "Choose Folder…";
                                enabled: !root.importing;
                                clicked => { root.browse_for_directory(); }
                            }
                            Text {
                                text: root.selected_directory;
                                wrap: word-wrap;
                                font-size: 10px;
                                color: #c0c0c0;
                            }
                            ScrollView {
                                vertical-stretch: 1;
                                Rectangle {
                                    horizontal-stretch: 1;
                                    vertical-stretch: 1;
                                    VerticalLayout {
                                        spacing: 4px;
                                        for dir_path[idx] in root.directories: Button {
                                            text: dir_path;
                                            horizontal-stretch: 1;
                                            enabled: !root.importing;
                                            clicked => {
                                                root.selected_directory = dir_path;
                                                root.directory_selected(dir_path);
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }

                // Center: thumbnails grid
                import_grid_panel := Rectangle {
                    background: #161616;
                    border-radius: 6px;
                    horizontal-stretch: 1;
                    thumbnail_scroll := ScrollView {
                        vertical-stretch: 1;

                        grid_container := Rectangle {
                            property <float> columns: {
                                let available = import_grid_panel.width - root.thumb_padding * 2;
                                let cell = root.card_width + root.thumb_gap;
                                let count = Math.floor(available / cell);
                                let min_cols = root.grid_columns;
                                let chosen = count < 1 ? 1 : count;
                                chosen < min_cols ? min_cols : chosen;
                            }
                            property <float> rows: {
                                let total = root.thumbnails.length;
                                if total == 0 { 1 } else { Math.ceil(total / self.columns) }
                            }
                            property <length> content-width: root.thumb_padding * 2
                                + self.columns * root.card_width
                                + (self.columns - 1) * root.thumb_gap;
                            property <length> content-height: root.thumb_padding * 2
                                + self.rows * root.card_height
                                + (self.rows - 1) * root.thumb_gap;

                            width: self.content-width > import_grid_panel.width ? self.content-width : import_grid_panel.width;
                            height: self.content-height;

                            for thumb[idx] in root.thumbnails: ImportThumbnailCard {
                                thumb-size: root.thumb_size;
                                card-width: root.card_width;
                                card-height: root.card_height;
                                selected: thumb.selected;
                                checked: thumb.checked;
                                path: thumb.path;
                                thumbnail: thumb.display_thumb;
                                selectable: !root.importing && thumb.selectable;
                                already-imported: thumb.already_imported;

                                x: root.thumb_padding + Math.mod(idx, grid_container.columns) * (root.card_width + root.thumb_gap);
                                y: root.thumb_padding + Math.floor(idx / grid_container.columns) * (root.card_height + root.thumb_gap);

                                thumbnail_clicked(shift, ctrl) => root.thumbnail_clicked(thumb.id, shift, ctrl);
                                checkbox_clicked(checked_state) => root.checkbox_clicked(checked_state);
                            }
                        }
                    }
                }

                // Right: destination picker
                Rectangle {
                    width: 280px;
                    visible: root.show_destination;
                    background: #181818;
                    border-radius: 6px;
                    HorizontalLayout {
                        padding: 8px;
                        VerticalLayout {
                            spacing: 8px;
                            Text { text: "Destination"; font-weight: 600; }
                            Button {
                                text: "Choose Destination…";
                                enabled: !root.importing;
                                clicked => root.browse_for_destination();
                            }
                            Text {
                                text: root.destination_directory;
                                wrap: word-wrap;
                                font-size: 10px;
                                color: #c0c0c0;
                            }
                        }
                    }
                }
            }

            // Keywords entry
            Rectangle {
                background: #181818;
                border-radius: 6px;
                VerticalLayout {
                    padding: 8px;
                    spacing: 6px;
                    Text { text: "Keywords (comma-separated)"; font-weight: 600; }
                    keywords_field := TextEdit {
                        text <=> root.keywords;
                        wrap: word-wrap;
                        read-only: root.importing;
                        vertical-stretch: 1;
                    }
                }
            }

            // Footer controls
            Rectangle {
                height: 90px;
                background: #121212;
                border-radius: 6px;
                HorizontalLayout {
                    padding: 10px;
                    spacing: 12px;
                    VerticalLayout {
                        width: 320px;
                        spacing: 8px;
                        ComboBox {
                            enabled: !root.importing;
                            model: ["Add", "Copy", "Move"];
                            current-value: root.current_method;
                            selected(current-value) => {
                                root.current_method = current-value;
                            }
                        }
                        HorizontalLayout {
                            spacing: 6px;
                            CheckBox {
                                text: "Check / Uncheck All";
                                enabled: !root.importing;
                                toggled => {
                                    root.select_all_requested(self.checked);
                                }
                            }
                            CheckBox {
                                text: "Import duplicates";
                                enabled: !root.importing;
                                checked <=> root.allow_duplicates;
                            }
                            Text {
                                text: "Selected " + root.selected_paths.length + " / " + root.thumbnails.length;
                                font-size: 11px;
                                color: #c0c0c0;
                            }
                        }
                    }

                    VerticalLayout {
                        spacing: 6px;
                        horizontal-stretch: 1;
                        ProgressIndicator {
                            visible: root.importing;
                            indeterminate: root.progress <= 0;
                            progress: min(max(root.progress, 0.0), 1.0);
                        }
                        Rectangle {
                            height: 6px;
                            horizontal-stretch: 1;
                            background: #1f1f1f;
                            border-radius: 3px;
                            Rectangle {
                                background: #3b82f6;
                                border-radius: 3px;
                                width: parent.width * min(max(root.progress, 0.0), 1.0);
                                height: parent.height;
                            }
                        }
                        Text {
                            text: root.status_text;
                            wrap: word-wrap;
                            color: #d0d0d0;
                        }
                        if root.error_messages.length > 0: ScrollView {
                            height: 60px;
                            Rectangle {
                                horizontal-stretch: 1;
                                vertical-stretch: 1;
                                VerticalLayout {
                                    for msg in root.error_messages: Text {
                                        text: "⚠ " + msg;
                                        color: #f09b4c;
                                        wrap: word-wrap;
                                        font-size: 11px;
                                    }
                                }
                            }
                        }
                    }

                    HorizontalLayout {
                        spacing: 8px;
                        Button {
                            text: "Cancel";
                            enabled: true;
                            clicked => root.cancel_import();
                        }
                        Button {
                            text: "Import";
                            enabled: !root.importing && root.selected_paths.length > 0;
                            clicked => {
                                root.perform_import(
                                    root.selected_directory,
                                    root.destination_directory,
                                    root.selected_paths,
                                    root.keywords,
                                    root.current_method,
                                );
                            }
                        }
                    }
                }
            }
        }
    }
}
}
