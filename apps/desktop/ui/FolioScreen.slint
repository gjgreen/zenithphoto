import { Button, ComboBox, ScrollView, SpinBox, TextEdit } from "std-widgets.slint";

export struct FolderTreeRow {
    name: string,
    full_path: string,
    level: int,
    expanded: bool,
    has_children: bool,
}

export struct VolumeNode {
    name: string,
    rows: [FolderTreeRow],
}

export struct VirtualCollectionItem {
    id: string,
    label: string,
}

export struct ThumbnailItem {
    id: int,
    path: string,
    display_thumb: image,
    rating: int,
    flag: string,
    color_label: string,
    selected: bool,
}

export struct ImageMetadata {
    file_path: string,
    captured_at: string,
    camera: string,
    lens: string,
    focal_length: string,
    aperture: string,
    shutter_speed: string,
    iso: string,
    gps_lat: string,
    gps_lon: string,
    rating: int,
    flag: string,
    color_label: string,
    keywords: [string],
}

export struct FolioFilters {
    search: string,
    rating: int,
    flag: string,
    color_label: string,
}

export global FolioTheme {
    public pure function label_color(label: string) -> brush {
        if (label == "Red" || label == "red") { return #ef4444; }
        if (label == "Yellow" || label == "yellow") { return #f59e0b; }
        if (label == "Green" || label == "green") { return #22c55e; }
        if (label == "Blue" || label == "blue") { return #3b82f6; }
        if (label == "Purple" || label == "purple") { return #a855f7; }
        return #666666;
    }

    public pure function color_index(label: string) -> int {
        if (label == "Red" || label == "red") { return 1; }
        if (label == "Yellow" || label == "yellow") { return 2; }
        if (label == "Green" || label == "green") { return 3; }
        if (label == "Blue" || label == "blue") { return 4; }
        if (label == "Purple" || label == "purple") { return 5; }
        return 0;
    }

    public pure function map_color_label(idx: int) -> string {
        if (idx == 1) { return "red"; }
        if (idx == 2) { return "yellow"; }
        if (idx == 3) { return "green"; }
        if (idx == 4) { return "blue"; }
        if (idx == 5) { return "purple"; }
        return "";
    }
}

component DiamondIcon inherits Rectangle {
    in property <bool> filled;
    in property <length> size: 11px;

    width: size;
    height: size;
    Path {
        width: parent.width;
        height: parent.height;
        stroke-width: 1.3px;
        stroke: filled ? #f2f2f2 : #9a9a9a;
        fill: filled ? #f2f2f2 : transparent;
        opacity: filled ? 1.0 : 0.45;
        commands: "M 5.5 0 L 11 5.5 L 5.5 11 L 0 5.5 Z";
    }
}

component CircleIcon inherits Rectangle {
    in property <brush> fill: #555;
    in property <bool> selected: false;

    width: 12px;
    height: 12px;
    border-radius: 6px;
    background: fill;
    border-width: selected ? 1.3px : 0px;
    border-color: selected ? #7aa7ff : transparent;
    animate background { duration: 120ms; }
}

component CheckIcon inherits Rectangle {
    in property <brush> stroke_color: #00c040;

    width: 14px;
    height: 12px;

    Path {
        width: 14px;
        height: 12px;
        stroke: stroke_color;
        stroke-width: 2px;
        fill: transparent;
        commands: "M 1 7 L 5 11 L 13 1";
    }
}

component CrossIcon inherits Rectangle {
    in property <brush> stroke_color: #ff4040;

    width: 12px;
    height: 12px;

    Path {
        width: 12px;
        height: 12px;
        stroke: stroke_color;
        stroke-width: 2px;
        fill: transparent;
        commands: "M 1 1 L 11 11 M 11 1 L 1 11";
    }
}

component ArrowIcon inherits Rectangle {
    in property <bool> expanded;

    width: 12px;
    height: 12px;
    background: transparent;

    Path {
        width: parent.width;
        height: parent.height;
        stroke: #c0c0c0;
        stroke-width: 1.4px;
        fill: #c0c0c0;
        commands: expanded ? "M 2 4 L 6 8 L 10 4 Z" : "M 4 2 L 8 6 L 4 10 Z";
    }
}

component FolderIcon inherits Rectangle {
    in property <bool> open: false;

    width: 16px;
    height: 14px;
    background: transparent;

    Path {
        width: parent.width;
        height: parent.height;
        stroke: #caa35f;
        stroke-width: 1.2px;
        fill: open ? #e6c17a : #d7b56a;
        commands: "M 1 4 L 5 4 L 7 2 L 15 2 L 15 12 L 1 12 Z";
    }
}

component FolderRow inherits Rectangle {
    in property <string> name;
    in property <bool> expanded;
    in property <int> level;
    in property <bool> has_children;
    in property <bool> selected: false;
    callback toggle();
    callback activate();

    height: 22px;
    horizontal-stretch: 1;
    border-radius: 4px;
    background: selected ? #1f3a70 : #181818;
    animate background { duration: 120ms; }

    HorizontalLayout {
        spacing: 4px;
        alignment: center;
        padding-left: level * 16px;
        padding-right: 8px;

        arrow_area := TouchArea {
            width: has_children ? 18px : 12px;
            height: parent.height;
            enabled: has_children;
            clicked => toggle();

            ArrowIcon {
                visible: has_children;
                expanded: root.expanded;
                x: (parent.width - self.width) / 2;
                y: (parent.height - self.height) / 2;
            }
        }

        TouchArea {
            horizontal-stretch: 1;
            height: parent.height;
            clicked => activate();

            HorizontalLayout {
                spacing: 6px;
                alignment: center;
                FolderIcon { open: root.has_children && root.expanded; }
                Text {
                    text: name;
                    color: #d0d0d0;
                    vertical-alignment: center;
                }
            }
        }
    }

}

component ThumbnailCard inherits Rectangle {
    in property <int> item-id;
    in property <string> path;
    in property <image> thumbnail;
    in property <bool> selected: false;
    in property <int> rating: 0;
    in property <string> flag: "";
    in property <string> color-label: "";
    in property <length> thumb-size: 200px;
    in property <length> card-width: 216px;
    in property <length> card-height: 272px;
    callback clicked(range_select: bool, toggle: bool);
    callback activated;

    width: card-width;
    height: card-height;
    preferred-width: card-width;
    preferred-height: card-height;
    border-radius: 8px;
    background: selected ? #1f3a70 : touch_area.has-hover ? #181818 : #141414;
    border-width: selected ? 2px : 1px;
    border-color: selected ? #3a6dff : #444;
    clip: true;

    animate background, border-color { duration: 120ms; }

    VerticalLayout {
        padding: 10px;
        spacing: 8px;
        width: parent.width;
        height: parent.height;

        Rectangle {
            background: #0a0a0a;
            border-radius: 6px;
            height: root.thumb-size;
            width: parent.width - 4px;
            Image {
                source: thumbnail;
                width: parent.width;
                height: parent.height;
                image-fit: contain;
                image-rendering: smooth;
            }
        }

        Text { text: path; font-size: 11px; wrap: no-wrap; overflow: elide; color: #d0d0d0; }

        badges := Rectangle {
            border-radius: 4px;
            background: selected ? #1c2744 : #101010;
            border-width: selected ? 1px : 0px;
            border-color: #2d4678;
            horizontal-stretch: 1;

            HorizontalLayout {
                spacing: 8px;
                padding-left: 8px;
                padding-right: 8px;
                padding-top: 4px;
                padding-bottom: 4px;

                HorizontalLayout {
                    spacing: 3px;
                    for i in 5: DiamondIcon { filled: (i + 1) <= rating; }
                }

                CircleIcon {
                    fill: FolioTheme.label_color(color-label);
                    selected: selected;
                    opacity: color-label == "none" ? 0.55 : 1.0;
                }

                if flag == "picked": CheckIcon { stroke_color: #00c040; }
                if flag == "rejected": CrossIcon { stroke_color: #ff4040; }
            }
        }
    }

    touch_area := TouchArea {
        width: parent.width;
        height: parent.height;
        double-clicked => activated();
        pointer-event(event) => {
            if (event.kind == PointerEventKind.up) {
                let toggle = event.modifiers.control || event.modifiers.meta;
                clicked(event.modifiers.shift, toggle);
            }
        }
    }

}

component MetaRow inherits HorizontalLayout {
    in property <string> label;
    in property <string> value;

    spacing: 6px;
    Text { text: label + ":"; color: #9a9a9a; width: 90px; }
    Text { text: value; wrap: word-wrap; color: #d0d0d0; horizontal-stretch: 1; }
}

component VirtualCollectionRow inherits Rectangle {
    in property <string> label;
    in property <string> kind;
    in property <string> selected_kind;
    callback activated(kind: string);

    height: 28px;
    horizontal-stretch: 1;
    border-radius: 4px;
    background: selected_kind == kind ? #1f3a70 : #181818;
    animate background { duration: 120ms; }

    HorizontalLayout {
        padding: 6px;
        Text { text: label; color: #d0d0d0; }
    }

    TouchArea { clicked => activated(kind); }
}

export component FolioScreen inherits Rectangle {
    in-out property <[VolumeNode]> volumes;
    in-out property <[VirtualCollectionItem]> virtual_collections_model;
    in-out property <[ThumbnailItem]> thumbnails;
    in-out property <ImageMetadata> metadata;
    in-out property <string> filter_search;
    in-out property <int> filter_rating: 0;
    in-out property <string> filter_flag;
    in-out property <string> filter_color_label;
    in-out property <int> selected_count: 0;
    in-out property <int> total_count: 0;
    in-out property <string> size_summary;
    in-out property <string> keywords_text;
    in-out property <int> selected_image_id: -1;
    in-out property <string> catalog_name;
    in-out property <string> selected_folder_path;
    in-out property <string> selected_virtual_collection;

    callback folder_selected(path: string);
    callback folder_toggled(path: string);
    callback virtual_collection_selected(kind: string);
    callback thumbnail_selected(image_id: int, range_select: bool, toggle: bool);
    callback thumbnail_activated(image_id: int);
    callback rating_changed(image_id: int, new_rating: int);
    callback flag_changed(image_id: int, new_flag: string);
    callback label_changed(image_id: int, new_label: string);
    callback update_keywords(image_id: int, keywords: string);
    callback filters_changed(search: string, rating: int, flag: string, color_label: string);
    callback reset_thumbnail_scroll;

    property <length> thumbnail-size: 200px;
    property <length> thumbnail-gap: 12px;
    property <length> thumbnail-grid-padding: 10px;
    property <length> thumbnail-grid-padding-y: 0px;
    property <length> thumbnail-card-width: root.thumbnail-size + 16px;
    property <length> thumbnail-card-height: root.thumbnail-size + 72px;

    background: #0f0f0f;

    HorizontalLayout {
        spacing: 10px;
        padding: 10px;

        // Folder tree
        Rectangle {
            width: 280px;
            border-radius: 8px;
            background: #151515;

            VerticalLayout {
                padding: 10px;
                spacing: 6px;
                alignment: start;
                Text {
                    text: "Catalog: " + catalog_name;
                    font-weight: 700;
                    color: #e0e0e0;
                    wrap: no-wrap;
                    overflow: elide;
                }

                VerticalLayout {
                    spacing: 4px;
                    for item in root.virtual_collections_model: VirtualCollectionRow {
                        label: item.label;
                        kind: item.id;
                        selected_kind: root.selected_virtual_collection;
                        activated(kind) => {
                            root.selected_virtual_collection = kind;
                            root.selected_folder_path = "";
                            root.virtual_collection_selected(kind);
                        }
                    }
                }

                Rectangle { height: 1px; background: #333; horizontal-stretch: 1; }

                folder_scroll := ScrollView {
                    vertical-stretch: 1;
                    viewport-height: folder_list.preferred-height;
                    viewport-width: folder_list.preferred-width;
                    folder_list := VerticalLayout {
                        padding: 2px;
                        spacing: 4px;
                        alignment: start;
                        horizontal-stretch: 1;

                        if root.volumes.length == 0: Text {
                            text: "No folders yet";
                            color: #8c8c8c;
                        }

                        for volume in root.volumes: VerticalLayout {
                            alignment: start;
                            spacing: 2px;
                            padding-top: 8px;
                            padding-bottom: 4px;

                            Text {
                                text: volume.name;
                                font-weight: 600;
                                color: #d8d8d8;
                            }

                            for folder in volume.rows: FolderRow {
                                name: folder.name;
                                expanded: folder.expanded;
                                level: folder.level;
                                has_children: folder.has_children;
                                selected: root.selected_folder_path == folder.full_path;

                                toggle => root.folder_toggled(folder.full_path);
                                activate => {
                                    root.selected_folder_path = folder.full_path;
                                    root.selected_virtual_collection = "";
                                    root.folder_selected(folder.full_path);
                                }
                            }
                        }
                    }
                }
            }
        }

        // Thumbnail grid and filters
        grid_panel := Rectangle {
            background: #121212;
            border-radius: 8px;
            horizontal-stretch: 1;
            property <length> inner_width: Math.max(self.width - 20px, 0px);

                VerticalLayout {
                padding: 10px;
                spacing: 10px;
                alignment: start;

                // Filters
                HorizontalLayout {
                    spacing: 8px;

                    TextEdit {
                        width: 220px;
                        height: 26px;
                        text: root.filter_search;
                        edited => {
                            root.filter_search = self.text;
                            root.filters_changed(
                                root.filter_search,
                                root.filter_rating,
                                root.filter_flag,
                                root.filter_color_label,
                            );
                        }
                    }

                    ComboBox {
                        width: 120px;
                        model: ["Any rating", "1+", "2+", "3+", "4+", "5"];
                        current-index: root.filter_rating;
                        selected(value) => {
                            root.filter_rating = self.current-index;
                            root.filters_changed(
                                root.filter_search,
                                root.filter_rating,
                                root.filter_flag,
                                root.filter_color_label,
                            );
                        }
                    }

                    ComboBox {
                        width: 120px;
                        model: ["Any flag", "Picked", "Rejected"];
                        current-index: root.filter_flag == "rejected" ? 2 : root.filter_flag == "picked" ? 1 : 0;
                        selected(value) => {
                            let flag_value = self.current-index == 1 ? "picked" : self.current-index == 2 ? "rejected" : "";
                            root.filter_flag = flag_value;
                            root.filters_changed(
                                root.filter_search,
                                root.filter_rating,
                                root.filter_flag,
                                root.filter_color_label,
                            );
                        }
                    }

                    ComboBox {
                        width: 140px;
                        model: ["Any label", "Red", "Yellow", "Green", "Blue", "Purple"];
                        current-index: FolioTheme.color_index(root.filter_color_label);
                        selected(value) => {
                            root.filter_color_label = FolioTheme.map_color_label(self.current-index);
                            root.filters_changed(
                                root.filter_search,
                                root.filter_rating,
                                root.filter_flag,
                                root.filter_color_label,
                            );
                        }
                    }

                    Rectangle {
                        horizontal-stretch: 1;
                    }
                }

                thumb_flick_container := Rectangle {
                    vertical-stretch: 1;
                    horizontal-stretch: 1;
                    clip: true;

                    thumb_flick := Flickable {
                        width: parent.width;
                        height: parent.height;
                        viewport-y: 0px;
                        viewport-x: 0px;
                        viewport-height: grid_container.height;
                        viewport-width: grid_container.width;

                        grid_container := Rectangle {
                            x: 0;
                            y: 0;
                            background: #161616;

                            property <float> columns: {
                                let available = grid_panel.inner_width - root.thumbnail-grid-padding * 2;
                                let cell = root.thumbnail-card-width + root.thumbnail-gap;
                                let count = Math.floor((available + root.thumbnail-gap) / cell);
                                if count < 1 { 1 } else if count > 8 { 8 } else { count }
                            }
                            property <float> rows: {
                                let total = root.thumbnails.length;
                                if total == 0 { 1 } else { Math.ceil(total / self.columns) }
                            }
                            property <length> content-width: root.thumbnail-grid-padding * 2
                                + self.columns * root.thumbnail-card-width
                                + (self.columns - 1) * root.thumbnail-gap;
                            property <length> content-height: root.thumbnail-grid-padding-y * 2
                                + self.rows * root.thumbnail-card-height
                                + (self.rows - 1) * root.thumbnail-gap;

                            width: self.content-width > grid_panel.inner_width ? self.content-width : grid_panel.inner_width;
                            height: self.content-height;
                            preferred-width: self.width;
                            preferred-height: self.height;

                            for thumb[idx] in root.thumbnails: ThumbnailCard {
                                thumb-size: root.thumbnail-size;
                                card-width: root.thumbnail-card-width;
                                card-height: root.thumbnail-card-height;

                                x: root.thumbnail-grid-padding + Math.mod(idx, grid_container.columns) * (root.thumbnail-card-width + root.thumbnail-gap);
                                y: root.thumbnail-grid-padding-y + Math.floor(idx / grid_container.columns) * (root.thumbnail-card-height + root.thumbnail-gap);

                                item-id: thumb.id;
                                path: thumb.path;
                                thumbnail: thumb.display_thumb;
                                selected: thumb.selected;
                                rating: thumb.rating;
                                flag: thumb.flag;
                                color-label: thumb.color_label;

                                clicked(range-select, toggle) => {
                                    root.thumbnail_selected(thumb.id, range-select, toggle);
                                }
                                activated => root.thumbnail_activated(thumb.id);
                            }
                        }

                        Text {
                            text: "grid: " + (grid_container.width / 1px) + "x" + (grid_container.height / 1px) + " cols=" + grid_container.columns + " rows=" + grid_container.rows;
                            color: #888;
                            font-size: 10px;
                            x: 6px;
                            y: 6px;
                        }
                    }
                }

                // Status bar
                Rectangle {
                    height: 32px;
                    border-radius: 6px;
                    background: #151515;

                    HorizontalLayout {
                        padding: 8px;
                        spacing: 12px;

                        Text { text: root.total_count + " images"; color: #c0c0c0; }
                        Text { text: root.selected_count + " selected"; color: #c0c0c0; }
                        Text { text: root.size_summary; color: #a0a0a0; }
                        Rectangle { horizontal-stretch: 1; }
                        Text { text: "telltale: scroll-fix v4"; color: #666; font-size: 10px; }
                    }
                }
            }
        }

        // Metadata panel
        Rectangle {
            width: 320px;
            border-radius: 8px;
            background: #151515;

            VerticalLayout {
                padding: 10px;
                spacing: 8px;

                Text { text: "Metadata"; font-weight: 700; color: #e0e0e0; }
                ScrollView {
                    vertical-stretch: 1;
                    Rectangle {
                        horizontal-stretch: 1;
                        VerticalLayout {
                            spacing: 6px;

                            MetaRow { label: "Path"; value: root.metadata.file_path; }
                            MetaRow { label: "Captured"; value: root.metadata.captured_at; }
                            MetaRow { label: "Camera"; value: root.metadata.camera; }
                            MetaRow { label: "Lens"; value: root.metadata.lens; }
                            MetaRow { label: "Focal"; value: root.metadata.focal_length; }
                            MetaRow { label: "Aperture"; value: root.metadata.aperture; }
                            MetaRow { label: "Shutter"; value: root.metadata.shutter_speed; }
                            MetaRow { label: "ISO"; value: root.metadata.iso; }
                            MetaRow { label: "GPS"; value: root.metadata.gps_lat + ", " + root.metadata.gps_lon; }

                            Rectangle { height: 8px; }

                            Text { text: "Rating"; color: #d0d0d0; font-weight: 600; }
                            SpinBox {
                                minimum: 0;
                                maximum: 5;
                                value: root.metadata.rating;
                                enabled: root.selected_image_id >= 0;
                                changed value => {
                                    if (root.selected_image_id >= 0 && self.value != root.metadata.rating) {
                                        root.rating_changed(root.selected_image_id, self.value);
                                    }
                                }
                            }

                            Text { text: "Flag"; color: #d0d0d0; font-weight: 600; }
                            ComboBox {
                                model: ["None", "Picked", "Rejected"];
                                current-index: root.metadata.flag == "picked" ? 1 : root.metadata.flag == "rejected" ? 2 : 0;
                                enabled: root.selected_image_id >= 0;
                                selected(value) => {
                                    let flag_value = self.current-index == 1 ? "picked" : self.current-index == 2 ? "rejected" : "none";
                                    if (root.selected_image_id >= 0 && flag_value != root.metadata.flag) {
                                        root.flag_changed(root.selected_image_id, flag_value);
                                    }
                                }
                            }

                            Text { text: "Color Label"; color: #d0d0d0; font-weight: 600; }
                            ComboBox {
                                model: ["None", "Red", "Yellow", "Green", "Blue", "Purple"];
                                current-index: FolioTheme.color_index(root.metadata.color_label);
                                enabled: root.selected_image_id >= 0;
                                selected(value) => {
                                    let label = FolioTheme.map_color_label(self.current-index);
                                    let normalized = label == "" ? "none" : label;
                                    if (root.selected_image_id >= 0 && normalized != root.metadata.color_label) {
                                        root.label_changed(root.selected_image_id, normalized);
                                    }
                                }
                            }

                            Text { text: "Keywords"; color: #d0d0d0; font-weight: 600; }
                            TextEdit {
                                text <=> root.keywords_text;
                                wrap: word-wrap;
                                vertical-stretch: 1;
                                enabled: root.selected_image_id >= 0;
                            }
                            Button {
                                text: "Update Keywords";
                                enabled: root.selected_image_id >= 0;
                                clicked => root.update_keywords(root.selected_image_id, root.keywords_text);
                            }
                        }
                    }
                }
            }
        }
    }

    reset_thumbnail_scroll => {
        thumb_flick.viewport-y = 0px;
        thumb_flick.viewport-x = 0px;
    }
}
