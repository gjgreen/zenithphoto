import { CatalogDialog } from "catalog_dialog.slint";
import { ImportPhotosScreen } from "ImportPhotosScreen.slint";
import { MainTabs } from "MainTabs.slint";
import { FolioScreen, VolumeNode, VirtualCollectionItem, ThumbnailItem, ImageMetadata } from "FolioScreen.slint";
import { RefineScreen } from "RefineScreen.slint";
export { CatalogDialog, ImportPhotosScreen }

export component MainWindow inherits Window {
    preferred-width: 1400px;
    preferred-height: 900px;
    min-width: 1024px;
    min-height: 720px;
    title: "ZenithPhoto";

    in-out property <int> current-tab: 0; // 0 = Folio, 1 = Refine
    in-out property <string> current-path;
    in-out property <[string]> recent-catalogs;
    in-out property <[VolumeNode]> volumes;
    in-out property <[VirtualCollectionItem]> virtual-collections;
    in-out property <string> selected-folder-path;
    in-out property <string> selected-virtual-collection;
    in-out property <string> catalog-name;
    in-out property <[ThumbnailItem]> thumbnails;
    in-out property <ImageMetadata> metadata;
    in-out property <string> filter-search: "";
    in-out property <int> filter-rating: 0;
    in-out property <string> filter-flag: "";
    in-out property <string> filter-color-label: "";
    in-out property <int> folio-selected-count: 0;
    in-out property <int> folio-total-count: 0;
    in-out property <string> folio-size-summary;
    in-out property <string> keywords-text;
    in-out property <int> selected-image-id: -1;
    in-out property <image> refine-preview;
    in-out property <string> refine-path;
    in-out property <int> refine-image-id: -1;
    in-out property <float> refine-exposure: 0.0;
    in-out property <float> refine-contrast: 0.0;
    in-out property <float> refine-highlights: 0.0;
    in-out property <float> refine-shadows: 0.0;
    in-out property <float> refine-whites: 0.0;
    in-out property <float> refine-blacks: 0.0;
    in-out property <string> status-text;

    callback new-catalog-requested();
    callback open-catalog-requested();
    callback open-recent-catalog-requested(path: string);
    callback clear-recent-catalogs-requested();
    callback import-photos-requested();
    callback exit-requested();

    callback folder-selected(path: string);
    callback folder-toggled(path: string);
    callback virtual-collection-selected(kind: string);
    callback thumbnail-selected(image_id: int, range_select: bool, toggle: bool);
    callback thumbnail-activated(image_id: int);
    callback rating-changed(image_id: int, new_rating: int);
    callback flag-changed(image_id: int, new_flag: string);
    callback label-changed(image_id: int, new_label: string);
    callback update-keywords(image_id: int, keywords: string);
    callback filters-changed(search: string, rating: int, flag: string, color_label: string);
    callback reset-thumbnail-scroll();
    callback remove-image-from-catalog(id: int);
    callback open-refine(image_id: int);
    callback apply-edits(
        image_id: int,
        exposure: float,
        contrast: float,
        highlights: float,
        shadows: float,
        whites: float,
        blacks: float
    );
    callback back-to-folio();

    forward-focus: shortcuts;

    menu := MenuBar {
        Menu {
            title: "File";

            MenuItem {
                title: "New Catalog...";
                activated => root.new-catalog-requested();
            }

            MenuItem {
                title: "Open Catalog...";
                activated => root.open-catalog-requested();
            }

            Menu {
                title: "Recent Catalogs";

                if root.recent-catalogs.length == 0: MenuItem {
                    title: "No Recent Catalogs";
                    enabled: false;
                }

                for entry in root.recent-catalogs: MenuItem {
                    title: entry;
                    activated => {
                        root.open-recent-catalog-requested(entry);
                    }
                }

                MenuSeparator { }

                MenuItem {
                    title: "Clear Recent Catalogs";
                    activated => root.clear-recent-catalogs-requested();
                }
            }

            MenuItem {
                title: "Import Photosâ€¦";
                activated => root.import-photos-requested();
            }

            MenuItem {
                title: "Exit";
                activated => root.exit-requested();
            }
        }
    }

    shortcuts := FocusScope {
        width: parent.width;
        height: parent.height;

        key_pressed(event) => {
            if (event.modifiers.control && (event.text == "o" || event.text == "O")) {
                root.open-catalog-requested();
                return accept;
            }

            if (event.modifiers.control && (event.text == "q" || event.text == "Q")) {
                root.exit-requested();
                return accept;
            }

            if ((event.modifiers.control || event.modifiers.meta) && (event.text == "i" || event.text == "I")) {
                root.import-photos-requested();
                return accept;
            }

            if ((event.text == "1")) {
                root.current-tab = 0;
                return accept;
            }

            if ((event.text == "2")) {
                root.current-tab = 1;
                return accept;
            }

            return reject;
        }

        VerticalLayout {
            spacing: 8px;
            padding: 8px;

            HorizontalLayout {
                spacing: 10px;
                MainTabs {
                    current_tab <=> root.current-tab;
                    open_folio => {
                        root.current-tab = 0;
                    }
                    open_refine => {
                        root.current-tab = 1;
                        root.open-refine(root.selected-image-id);
                    }
                }

                Rectangle {
                    horizontal-stretch: 1;
                }

                Text {
                    text: root.current-path;
                    color: #9a9a9a;
                }
            }

            if root.status-text != "": Rectangle {
                height: 28px;
                border-radius: 6px;
                background: #1b2a48;
                HorizontalLayout {
                    padding: 8px;
                    Text { text: root.status-text; color: #c9defb; }
                }
            }

            content_area := Rectangle {
                horizontal-stretch: 1;
                vertical-stretch: 1;
                clip: true;

                folio := FolioScreen {
                    width: parent.width;
                    height: parent.height;
                    visible: root.current-tab == 0;

                    volumes <=> root.volumes;
                    virtual_collections_model <=> root.virtual-collections;
                    selected_folder_path <=> root.selected-folder-path;
                    selected_virtual_collection <=> root.selected-virtual-collection;
                    catalog_name <=> root.catalog-name;
                    thumbnails <=> root.thumbnails;
                    metadata <=> root.metadata;
                    filter_search <=> root.filter-search;
                    filter_rating <=> root.filter-rating;
                    filter_flag <=> root.filter-flag;
                    filter_color_label <=> root.filter-color-label;
                    selected_count <=> root.folio-selected-count;
                    total_count <=> root.folio-total-count;
                    size_summary <=> root.folio-size-summary;
                    keywords_text <=> root.keywords-text;
                    selected_image_id <=> root.selected-image-id;

                    folder_selected(path) => root.folder-selected(path);
                    folder_toggled(path) => root.folder-toggled(path);
                    virtual_collection_selected(kind) => root.virtual-collection-selected(kind);
                    thumbnail_selected(image_id, range_select, toggle) => root.thumbnail-selected(image_id, range_select, toggle);
                    thumbnail_activated(image_id) => {
                        root.selected-image-id = image_id;
                        root.current-tab = 1;
                        root.open-refine(image_id);
                    }
                    rating_changed(image_id, new_rating) => root.rating-changed(image_id, new_rating);
                    flag_changed(image_id, new_flag) => root.flag-changed(image_id, new_flag);
                    label_changed(image_id, new_label) => root.label-changed(image_id, new_label);
                    update_keywords(image_id, keywords) => root.update-keywords(image_id, keywords);
                    filters_changed(search, rating, flag, color_label) => root.filters-changed(search, rating, flag, color_label);
                    remove_image_from_catalog(image_id) => root.remove-image-from-catalog(image_id);
                }

                refine := RefineScreen {
                    width: parent.width;
                    height: parent.height;
                    visible: root.current-tab == 1;

                    image_id <=> root.refine-image-id;
                    file_path <=> root.refine-path;
                    preview_image <=> root.refine-preview;
                    exposure <=> root.refine-exposure;
                    contrast <=> root.refine-contrast;
                    highlights <=> root.refine-highlights;
                    shadows <=> root.refine-shadows;
                    whites <=> root.refine-whites;
                    blacks <=> root.refine-blacks;
                    apply_edits(image_id, exposure, contrast, highlights, shadows, whites, blacks) => root.apply-edits(image_id, exposure, contrast, highlights, shadows, whites, blacks);
                    back_to_folio => {
                        root.current-tab = 0;
                        root.back-to-folio();
                    }
                }
            }
        }
    }

    reset-thumbnail-scroll => {
        folio.reset_thumbnail_scroll();
    }
}
